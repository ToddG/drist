#!/bin/sh
#vim:ts=4:shiftwidth=4:

##
# drist --
# A tool to configure and synchronize configurations to, and/or
# run scrips on remote host(s) via scp(1) and ssh(1).
#
# SYNOPSIS
# drist [-p] [-d] [-e [sudo|doas]] [-S script] [-f files-directory] [-F file-to-copy] destination [...]
# 
# -----------------------------------------------------------------------------
# Copyright (c) 2018, Rapenne SolÃ¨ne
# Copyright (c) 2025, John Kaul
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
# 
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
# 
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# -----------------------------------------------------------------------------

# ---[ GLOBALS ]--------------------------------------------------
PRIVILEGES=0                  # Run with escalated privileges
PRIVILEGES_BIN=doas           # binary to run privileged command.
EXEC='exec sh -c'			  # posix compliant shell.
SSHONCE=0                     # set up a socket for persistent connection.
TRUNCATE=0                    # Remove the domain name from the hostname.
USE_FILE="script"             # default script file to upload if no optional switches.
USE_DIR="files"               # default directory to upload if no optional switches.
SSH_PARAMS=""				  # default ssh parameters.
COPY_FILE=""			      # default single file to copy.

# ---[ HELPERS ]--------------------------------------------------
##
# usage --
# @brief displays usage information.
usage() {
    echo "$0 v2.05"
    echo "$0 [-p] [-d] [-e [sudo|doas]] [-S script-to-run] [-f files-to-copy-directory] [-F single-file-to-copy] destination [...]"
    exit 0
}

##
# copy_files --
# @brief Copy files from a local directory to a remote server.
#
# Parameters:
#   $1 - source directory (e.g. /path/files-server.local)
#   $2 - remote server name (e.g. server)
#   $3 - remote tempdir target (e.g. ~/.drist_files_XXXXXXXXXXXXXXX)
copy_files() {
    src_dir=$1
    remote_server=$2
    remote_tmp=$3

    if [ -d "${src_dir}" ]; then
        # create list file
        LIST=$(mktemp /tmp/drist-sync.XXXXXXXXXX)
        # Get the current working directory.
        CWD=$(pwd)
        if [ -f "$LIST" ]; then
            # -l = keep symlink / -D = special device
            find "${src_dir}" -type f -or -type l | sed "s#^${src_dir}/##" > "${LIST}"
            # basename of source dir (e.g. files-server.local from /path/files-server.local)
            SRC_BASE=$(basename -- "${src_dir}")

			# Copy files to remote host.
			tar -cf - -C . . | ssh $SSH_PARAMS "${remote_server}" 'tar -xf - -C '"${remote_tmp}"

			# Move files into place.
			ssh $SSH_PARAMS "${remote_server}" "tar -cf - -C "${remote_tmp}"/"$SRC_BASE" . | tar -xf - -C \"\$HOME\""

            rm "$LIST"
        fi
    fi
}

##
# copy_single_file --
# @brief Copy a single file from a local directory to a remote server.
#
# Parameters:
#   $1 - source file (e.g. /path/upload.file)
#   $2 - remote server name (e.g. server)
#   $3 - remote tempdir target (e.g. ~/.drist_files_XXXXXXXXXXXXXXX)
copy_single_file() {
    src_file=$1
    remote_server=$2
    remote_tmp=$3

    if [ -f "${src_file}" ]; then
        # create list file
        LIST=$(mktemp /tmp/drist-sync.XXXXXXXXXX)
        # Get the current working directory.
        CWD=$(pwd)                      # Get the current working directory.
        if [ -f "$LIST" ]; then
            # -l = keep symlink / -D = special device
            find "${src_file}" -type f -or -type l | sed "s#^${src_file}/##" > "${LIST}"

            cd "$(dirname -- "$src_file")"
            FILE_NAME=$(basename -- "$src_file")

			# copy file to remote host.
			tar -cf - -C . "./${FILE_NAME}" | ssh $SSH_PARAMS "${remote_server}" 'tar -xf - -C '"${remote_tmp}"

			# move file into place.
			ssh $SSH_PARAMS "${remote_server}" "tar -cf - -C \"$remote_tmp\" . | tar -xf - -C \"\$HOME\""
            cd ${CWD}                   # Change back to current working directory.
            rm "$LIST"
        fi
    fi
}

##
# remote_script --
# @brief Executes script on remote host.
#
# Parameters:
#   $1 - script file (e.g. /path/script)
#   $2 - remote server name (e.g. server)
#   $3 - remote tempdir target (e.g. ~/.drist_files_XXXXXXXXXXXXXXX)
remote_script() {
    src_dir=$1
    remote_server=$2
    remote_tmp=$3

    if [ -f "${src_dir}" ]; then
        FILE=$(basename ${USE_FILE})
        ssh $SSH_PARAMS "${remote_server}" "cd ${remote_tmp} && \
            cat - > ${remote_tmp}/${FILE} && \
            chmod u+x ${remote_tmp}/${FILE} && \
            ${EXEC} ${remote_tmp}/${FILE}" < "$src_dir"
    fi
}

##
# create_temp --
# @brief Creates temporary directory on remote host.
#
# Parameters:
#   $1 - remote server name (e.g. server)
create_temp() {
    remote_server=$1

    TEMPDIR=$(ssh $SSH_PARAMS "${remote_server}" "mktemp -d ~/.drist_files_XXXXXXXXXXXXXXX")
    if [ "$TEMPDIR" = "" ]; then
        echo "mktemp error, aborting"
        exit 1
    fi
}

##
# delete_temp --
# @brief Deletes temporary directory on remote host.
#
# Parameters:
#   $1 - remote server name (e.g. server)
#   $2 - remote tempdir target (e.g. ~/.drist_files_XXXXXXXXXXXXXXX)
delete_temp() {
    remote_server=$1
    remote_tmp=$2

    # The following is a debug print.
    if echo "${2}" | grep drist_files_ >/dev/null ; then
        ssh $SSH_PARAMS "$remote_server" "rm -fr ${remote_tmp}"
    else
        echo "Problem, TEMPDIR was reset during execution, current value is = $remote_tmp"
        exit 2
    fi
}


# ---[ ARGUMENT PARSER ]------------------------------------------
# (custom getopt() like argument parser)

# check to see if we have enough arguments.
if [ $# -lt 1 ]; then echo "Not enough arguments."; fi

# flag to set when done processing arguments.
done_options=

##
# @brief check to see if there are more arguments to parse.
#
# @return 1 if done 0 if more args.
more_options() {
    test $done_options && return 1
    [ $# -eq 0 ] && return 1
    case "$1" in
        --) return 1 ;;   # stop options
        -*) return 0 ;;
        *) return 1 ;;
    esac
}

# parse arguments.
while more_options "$1"
do
    case "$1" in
        --)
            done_options=1
            shift
            break
            ;;
        -h*)                                            # Help
            usage
            ;;
        -d)                                             # truncate hostname
            TRUNCATE=1
            ;;
        -p)                                             # persistent ssh
            SSHONCE=1
            ;;
        -S)                                             # script file to run
            [ $# -gt 1 ] || usage "-S requires a script name"
            shift
            USE_FILE="$1"
            ;;
        -f)                                             # directory of files to upload
            [ $# -gt 1 ] || usage "-f requires a directory location"
            shift
            USE_DIR="$1"
            ;;
        -F)                                             # file to upload
            [ $# -gt 1 ] || usage "-F requires a file name"
            shift
            COPY_FILE="$1"
            ;;
        -e*)                                            # elevate permissions.
            if [ $# -gt 1 ] && case "$2" in -*) false;; *) true;; esac; then
                shift
                PRIVILEGES_BIN="${1#-e}"
            fi
            PRIVILEGES=1
            ;;
        -*)
            usage "unknown option $1"
            ;;
    esac
    shift
done

# ---[ RUNTIME ]--------------------------------------------------
# allow to use a privilege escalation program
if [ "$PRIVILEGES" -eq 1 ]; then
    EXEC="$PRIVILEGES_BIN"
fi

# use ControlMaster to make connections persistent
if [ "$SSHONCE" -eq 1 ]; then
   SSH_PARAMS='-o ControlMaster=auto -o ControlPath=/tmp/drist_ssh_%h_%p_%r.sock -o ControlPersist=1m'
fi

# start looping over server list
if [ -f "$1" ]; then
    SERVER_LIST="$(tr '\n' ' ' < $1)"
else
    SERVER_LIST="$@"
fi

if [ "${SERVER_LIST}" = "" ]; then
    echo "No server specified"
    exit 1
fi

for remote_server in ${SERVER_LIST}
do

  # check if host exists
  HOSTNAME=$(ssh $SSH_PARAMS "$remote_server" "uname -n")
  if [ "$?" -ne 0 ]; then
      echo "Error while ssh ${remote_server}"
      exit 2
  fi

  if [ "$TRUNCATE" -eq 1 ]; then
      HOSTNAME="${HOSTNAME%%.*}"
  fi

  create_temp "${remote_server}"
  copy_files "${USE_DIR}" "${remote_server}" "$TEMPDIR"
  copy_files "${USE_DIR}-${HOSTNAME}" "${remote_server}" "$TEMPDIR"
  copy_single_file "${COPY_FILE}" "${remote_server}" "$TEMPDIR"
  copy_single_file "${COPY_FILE}-${HOSTNAME}" "${remote_server}" "$TEMPDIR"
  remote_script "${USE_FILE}" "${remote_server}" "$TEMPDIR"
  remote_script "${USE_FILE}-${HOSTNAME}" "${remote_server}" "$TEMPDIR"
  delete_temp "${remote_server}" "$TEMPDIR"

  # close socket if persistence is active
  if [ "$SSHONCE" -eq 1 ]; then
      ssh $SSH_PARAMS -O exit -N "$1"
  fi

  unset TEMPDIR HOSTNAME
done
